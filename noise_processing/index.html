<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://projectisp.github.io/ISP_tutorial.github.io/noise_processing/">
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Noise Processing - ISP Tutorial</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/fontawesome.min.css" rel="stylesheet">
        <link href="../css/brands.min.css" rel="stylesheet">
        <link href="../css/solid.min.css" rel="stylesheet">
        <link href="../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/color-brewer.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">ISP Tutorial</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href=".." class="nav-link">Home</a>
                            </li>
                            <li class="nav-item">
                                <a href="../install/" class="nav-link">Installation</a>
                            </li>
                            <li class="nav-item">
                                <a href="../basics/" class="nav-link">Start with the basics</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Modules</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../el/" class="dropdown-item">Earthquake Location</a>
</li>
                                    
<li>
    <a href="../tf/" class="dropdown-item">Time-Frequency Analysis</a>
</li>
                                    
<li>
    <a href="../mti/" class="dropdown-item">Seismic Moment Tensor Inversion</a>
</li>
                                    
<li>
    <a href="../aa/" class="dropdown-item">Array Analysis</a>
</li>
                                    
<li>
    <a href="../rf/" class="dropdown-item">Receiver Functions</a>
</li>
                                    
<li>
    <a href="../ant/" class="dropdown-item">Ambient Noise Tomography</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Additional Toolboxes</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../db/" class="dropdown-item">Database</a>
</li>
                                    
<li>
    <a href="../rd/" class="dropdown-item">Retrieve Data</a>
</li>
                                    
<li>
    <a href="../ppsds/" class="dropdown-item">PPSDs</a>
</li>
                                    
<li>
    <a href="../synth/" class="dropdown-item">Synthetic Generator</a>
</li>
                                    
<li>
    <a href="../nrt/" class="dropdown-item">Near Real Time Adquisition</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Signal Processing</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../sp_filtering/" class="dropdown-item">Basic Processing Tools</a>
</li>
                                    
<li>
    <a href="../remove_response/" class="dropdown-item">Remove Instrument Response</a>
</li>
                                    
<li>
    <a href="../sp_integrate/" class="dropdown-item">Integrate & Differenciate</a>
</li>
                                    
<li>
    <a href="../smoothing/" class="dropdown-item">Smoothing</a>
</li>
                                    
<li>
    <a href="../sp_denoising/" class="dropdown-item">Denoising</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Noise Processing</a>
</li>
                                    
<li>
    <a href="../resample/" class="dropdown-item">Resampling</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item">
                                <a href="../progress/" class="nav-link">Gallery & Progress</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">About</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../refs/" class="dropdown-item">References</a>
</li>
                                    
<li>
    <a href="../license.md" class="dropdown-item">License</a>
</li>
                                    
<li>
    <a href="../release_notes/" class="dropdown-item">Release Notes</a>
</li>
                                    
<li>
    <a href="../FAQs.md" class="dropdown-item">FAQs</a>
</li>
                                    
<li>
    <a href="../Special_Thanks/" class="dropdown-item">The Developer Team of ISP thanks to:</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../sp_denoising/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../resample/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#noise-processing-in-seismology" class="nav-link">Noise Processing in Seismology</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#introduction" class="nav-link">Introduction</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#1-simulating-noise" class="nav-link">1. Simulating Noise</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#2-preparing-noise-for-cross-correlation" class="nav-link">2. Preparing Noise for Cross-Correlation</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#3-best-practices-for-noise-processing" class="nav-link">3. Best Practices for Noise Processing</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#4-use-case-noise-cross-correlation" class="nav-link">4. Use Case: Noise Cross-Correlation</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#summary" class="nav-link">Summary</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="noise-processing-in-seismology">Noise Processing in Seismology</h1>
<h2 id="introduction">Introduction</h2>
<p>Seismic noise is not merely a nuisance — it holds valuable information about the Earth's structure when properly processed. In modern seismology, especially in ambient noise tomography and passive imaging, noise becomes the <strong>signal</strong>. Understanding how to manipulate, simulate, and prepare noise for analysis is essential.</p>
<p>This tutorial presents techniques to:
- <strong>Simulate noise</strong> (white or colored)
- <strong>Preprocess data</strong> for noise cross-correlation
- Apply <strong>time-domain normalization</strong> and <strong>spectral whitening</strong></p>
<hr />
<h2 id="1-simulating-noise">1. Simulating Noise</h2>
<p>Synthetic noise allows us to test algorithms, study SNR effects, and validate signal extraction procedures.</p>
<h3 id="11-adding-white-noise">1.1 Adding White Noise</h3>
<p>White noise has equal power across all frequencies. It's useful for basic testing or simulating high-frequency noise.</p>
<p><strong>Equation:</strong><br />
$$
x_{noisy}[n] = x[n] + \alpha \cdot \mathcal{N}(0, 1)
$$</p>
<p>Where:
- <span class="arithmatex">\( x[n] \)</span>: original signal
- <span class="arithmatex">\( \alpha \)</span>: noise amplitude scaling factor
- <span class="arithmatex">\( \mathcal{N}(0, 1) \)</span>: standard normal distribution</p>
<pre><code class="language-python">def add_white_noise(trace, noise_level=0.01):
    noise = np.random.normal(0, noise_level, len(trace.data))
    trace.data += noise
    return trace
</code></pre>
<hr />
<h3 id="12-adding-colored-noise-eg-pink-brown">1.2 Adding Colored Noise (e.g., Pink, Brown)</h3>
<p>Colored noise has a power spectral density inversely proportional to frequency.</p>
<p><strong>Example</strong>:<br />
- Pink noise: <span class="arithmatex">\( P(f) \propto 1/f \)</span>
- Brown noise: <span class="arithmatex">\( P(f) \propto 1/f^2 \)</span></p>
<pre><code class="language-python">def add_colored_noise(trace, exponent=1):
    white = np.random.randn(len(trace.data))
    fft = np.fft.rfft(white)
    freqs = np.fft.rfftfreq(len(trace.data), d=trace.stats.delta)
    fft /= np.where(freqs == 0, 1, freqs ** (exponent / 2))
    noise = np.fft.irfft(fft, n=len(trace.data))
    trace.data += noise
    return trace
</code></pre>
<hr />
<h2 id="2-preparing-noise-for-cross-correlation">2. Preparing Noise for Cross-Correlation</h2>
<p>Before computing noise cross-correlations, raw noise traces must be <strong>normalized and whitened</strong> to emphasize coherent signals and suppress local bursts or instrument artifacts.</p>
<hr />
<h3 id="21-time-domain-normalization-eg-one-bit-normalization">2.1 Time-Domain Normalization (e.g., One-Bit Normalization)</h3>
<p>Time normalization standardizes amplitude fluctuations to reduce the influence of transient spikes or earthquakes.</p>
<p><strong>One-bit normalization:</strong></p>
<div class="arithmatex">\[
x_{norm}[n] =   ext{sign}(x[n])
\]</div>
<p>Removes amplitude info, keeps polarity.</p>
<pre><code class="language-python">def one_bit_normalize(trace):
    trace.data = np.sign(trace.data)
    return trace
</code></pre>
<ul>
<li><strong>Clipping normalization</strong> (cap values at ± threshold)</li>
</ul>
<div class="arithmatex">\[
x_{norm}[n] = 
\begin{cases}
  -C &amp;  ext{if } x[n] &lt; -C \\
  x[n] &amp;    ext{if } -C \leq x[n] \leq C \\
  +C &amp;  ext{if } x[n] &gt; C
\end{cases}
\]</div>
<pre><code class="language-python">
def normalize_clip(tr,clip_factor=6, clip_weight=10, norm_method='clipping')

    if norm_method == 'clipping':
        lim = clip_factor * np.std(tr.data)
        tr.data[tr.data &gt; lim] = lim
        tr.data[tr.data &lt; -lim] = -lim

    elif norm_method == &quot;clipping_iter&quot;:
        lim = clip_factor * np.std(np.abs(self.tr.data))

        # as long as still values left above the waterlevel, clip_weight
        while tr.data[np.abs(self.tr.data) &gt; lim] != []:
            tr.data[tr.data &gt; lim] /= clip_weight
            tr.data[tr.data &lt; -lim] /= clip_weight
</code></pre>
<ul>
<li><strong>Running absolute mean normalization</strong></li>
</ul>
<div class="arithmatex">\[
x_{norm}[n] = \frac{x[n]}{\frac{1}{W} \sum_{i=n-W/2}^{n+W/2} |x[i]|}
\]</div>
<p>Where:
- <span class="arithmatex">\( W \)</span>: window length in samples<br />
- <span class="arithmatex">\( |x[i]| \)</span>: absolute value of the signal within the window</p>
<pre><code class="language-python">def normalize(tr, norm_win=15):
    norm_win = int(norm_win*tr.stats.sampling_rate)
    window = np.ones(norm_win)/norm_win
    tr.data = tr.data/np.convolve(np.abs(self.tr.data), window, mode='same')
    tr.taper(type=&quot;blackman&quot;, max_percentage=0.05)
</code></pre>
<hr />
<h3 id="22-spectral-whitening">2.2 Spectral Whitening</h3>
<p>Spectral whitening equalizes all frequency bands to prevent dominance by low frequencies.</p>
<p><strong>Conceptual Equation:</strong></p>
<p>Given the FFT of a trace <span class="arithmatex">\( X(f) \)</span>, and the smoothed amplitude <span class="arithmatex">\( A_{avg}(f) \)</span>, whitening is done as:</p>
<div class="arithmatex">\[
X_{white}(f) = \frac{X(f)}{A_{avg}(f)}
\]</div>
<p>Where:
- <span class="arithmatex">\( A_{avg}(f) \)</span>: computed as a moving average of <span class="arithmatex">\( |X(f)| \)</span> over a specified frequency bandwidth</p>
<pre><code class="language-python">def spectral_whitening(tr, freq_width=0.05, taper_edge=True):

    &quot;&quot;&quot;&quot;
    freq_width: Frequency smoothing windows [Hz] / both sides
    taper_edge: taper with cosine window the low frequencies

    return: whithened trace (Phase is not modified)
    &quot;&quot;&quot;&quot;&quot;

    fs = tr.stats.sampling_rate
    N = tr.count()
    D = 2 ** math.ceil(math.log2(N))
    freq_res = 1 / (D / fs)
    # N_smooth = int(freq_width / (2 * freq_res))
    N_smooth = int(freq_width / (freq_res))

    if N_smooth % 2 == 0:  # To have a central point
        N_smooth = N_smooth + 1
    else:
        pass

    # avarage_window_width = (2 * N_smooth + 1) #Denominador
    avarage_window_width = (N_smooth + 1)  # Denominador
    half_width = int((N_smooth + 1) / 2)  # midpoint
    half_width_pos = half_width - 1

    # Prefilt
    tr.detrend(type='simple')
    tr.taper(max_percentage=0.05)

    # ready to whiten
    data = tr.data
    data_f = np.fft.rfft(data, D)
    freq = np.fft.rfftfreq(D, 1. / fs)
    N_rfft = len(data_f)
    data_f_whiten = data_f.copy()
    index = np.arange(0, N_rfft - half_width, 1)

    data_f_whiten = whiten_aux(data_f, data_f_whiten, index, half_width, avarage_window_width, half_width_pos)

    # Taper (optional) and remove mean diffs in edges of the frequency domain

    wf = (np.cos(np.linspace(np.pi / 2, np.pi, half_width)) ** 2)

    if taper_edge:

        diff_mean = np.abs(np.mean(np.abs(data_f[0:half_width])) - np.mean(np.abs(data_f_whiten[half_width:])) * wf)

    else:

        diff_mean = np.abs(np.mean(np.abs(data_f[0:half_width])) - np.mean(np.abs(data_f_whiten[half_width:])))

    diff_mean2 = np.abs(
        np.mean(np.abs(data_f[(N_rfft - half_width):])) - np.mean(np.abs(data_f_whiten[(N_rfft - half_width):])))

    if taper_edge:

        data_f_whiten[0:half_width] = ((data_f[0:half_width]) / diff_mean)*wf  # First part of spectrum tapered
    else:

        data_f_whiten[0:half_width] = ((data_f[0:half_width]) / diff_mean)


    data_f_whiten[(N_rfft - half_width):] = (data_f[(N_rfft - half_width):]) / diff_mean2  # end of spectrum
    data = np.fft.irfft(data_f_whiten)
    data = data[0:N]
    tr.data = data

    return tr
</code></pre>
<p><strong>Best Practice:</strong><br />
Always apply tapering by applying a bandpass filtering before whitening to avoid spectral edge effects and aliasing.</p>
<hr />
<h2 id="3-best-practices-for-noise-processing">3. Best Practices for Noise Processing</h2>
<table>
<thead>
<tr>
<th>Step</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>Add synthetic noise</td>
<td>Test methods, control SNR</td>
</tr>
<tr>
<td>One-bit normalization</td>
<td>Reduce spike/earthquake bias</td>
</tr>
<tr>
<td>Spectral whitening</td>
<td>Flatten spectrum, enhance coherence</td>
</tr>
<tr>
<td>Detrend &amp; taper</td>
<td>Prevent spectral artifacts</td>
</tr>
<tr>
<td>Bandpass filter</td>
<td>Limit frequency range before analysis</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="4-use-case-noise-cross-correlation">4. Use Case: Noise Cross-Correlation</h2>
<p>After applying time and spectral normalization:</p>
<pre><code class="language-python">from obspy.signal.cross_correlation import correlate

# Preprocess both traces
tr1 = spectral_whitening(one_bit_normalize(tr1))
tr2 = spectral_whitening(one_bit_normalize(tr2))

# Cross-correlate
cc = correlate(tr1.data, tr2.data, shift=len(tr1.data)//2)
</code></pre>
<p>This produces a <strong>noise correlation function (NCF)</strong> which may approximate the Green's function between the two stations.</p>
<hr />
<h2 id="summary">Summary</h2>
<p>Noise processing transforms chaotic raw signals into usable seismic information. Whether simulating realistic environments with colored noise or preparing for cross-correlation via one-bit normalization and spectral whitening, these steps are essential for passive imaging and ambient noise studies.</p>
<p>This pipeline is fully integrated into the <code>ISP</code> processing tools, enabling robust and flexible ambient noise workflows.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>&copy; 2025 <a href="https://robertocabieces.com"  target="_blank" rel="noopener">Roberto Cabieces</a>
</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../javascripts/mathjax.js"></script>
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
